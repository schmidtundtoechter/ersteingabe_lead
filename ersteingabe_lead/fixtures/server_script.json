[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-02-06 15:23:06.306045",
  "module": "Ersteingabe Lead",
  "name": "Ersteingabe Lead Script",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Ersteingabe Lead",
  "script": "# Server Script for \"Ersteingabe Lead AZ-IT\"\r\n# Trigger: Before Save\r\n\r\n# Step 1: Create the 'kompletter_name' based on 'vornahme', 'zweiter_vornahme', 'nachnahme'\r\nname_parts = []\r\n\r\nif doc.vornahme:\r\n    name_parts.append(doc.vornahme)\r\n\r\nif doc.zweiter_vornahme:\r\n    name_parts.append(doc.zweiter_vornahme)\r\n\r\nif doc.nachnahme:\r\n    name_parts.append(doc.nachnahme)\r\n\r\n# Zusammensetzen der Namensteile mit Leerzeichen\r\ndoc.kompletter_name = \" \".join(name_parts)\r\n\r\n# Step 2: Create new Lead entry\r\nnew_lead = frappe.get_doc({\r\n    \"doctype\": \"Lead\",\r\n    \"status\": \"Lead\",\r\n    \"custom_status_intern\": \"Lead\",\r\n    \"company_name\": doc.hfz,\r\n    \"custom_thema\": doc.thema,\r\n    \"custom_leadquelle\": doc.leadquelle,\r\n    \"job_title\": doc.position,\r\n    \"salutation\": doc.anrede,\r\n    \"first_name\": doc.vornahme,\r\n    \"middle_name\": doc.zweiter_vornahme,\r\n    \"last_name\": doc.nachnahme,\r\n    \"lead_name\": doc.kompletter_name,\r\n    \"gender\": doc.geschlecht,\r\n    \"custom_adresse_mutterunternehmen\": doc.adresse_mutterunternehmen,\r\n    \"custom_kontakt_mutterunternehmen\": doc.kontakt_mutterunternehmen,\r\n    \"no_of_employees\": doc.select_lapl,\r\n    \"industry\": doc.wirtschaftsbranche,\r\n    \"custom_straße\": doc.adresse_zeile_1,\r\n    \"custom_hausnummer\": doc.adresse_zeile_2,\r\n    \"custom_ort\": doc.ort_wohnort,\r\n    \"custom_plz\": doc.plz,\r\n    \"custom_land\": doc.land,\r\n    \"address_html\": doc.webseite,\r\n    \"campaign_name\": doc.kampagnenname,\r\n    \"language\": doc.drucksprache,\r\n    \"disabled\": doc.deaktiviert,\r\n    \"unsubscribed\": doc.unsubscribed,\r\n    \"blog_subscriber\": doc.blog_subscriber,\r\n    \"company\": \"AZ IT-Systems & Consulting GmbH\",\r\n    \"custom_tel_zentrale\": doc.telefon_zentrale,\r\n    \"email_id\" : doc.email,\r\n    \"website\" : doc.webseite\r\n    \r\n})\r\n\r\n# Speichern des Leads\r\nnew_lead.insert(ignore_permissions=True)\r\n\r\n# Step 3: Remove automatically generated Contact (if any)\r\nauto_contact = frappe.get_all(\"Contact\", filters={\"link_doctype\": \"Lead\", \"link_name\": new_lead.name})\r\nif auto_contact:\r\n    for contact in auto_contact:\r\n        frappe.delete_doc(\"Contact\", contact.name, ignore_permissions=True)\r\n\r\n# Step 4: Create new Contact entry\r\nnew_contact = frappe.get_doc({\r\n    \"doctype\": \"Contact\",\r\n    \"custom_präfix\": doc.titel,\r\n    \"first_name\": doc.vornahme,\r\n    \"middle_name\": doc.zweiter_vornahme,\r\n    \"last_name\": doc.nachnahme,\r\n    \"salutation\": doc.anrede,\r\n    \"designation\": doc.position,\r\n    \"gender\": doc.geschlecht,\r\n    \"company_name\": doc.hfz,\r\n    \"status\": \"Passive\",\r\n    \"is_primary_contact\": doc.ist_hauptkontakt,\r\n    \"is_billing_contact\": doc.ist_primärer_rechnungskontakt,\r\n    \"department\": doc.abteilung\r\n})\r\n\r\n# Speichern des Kontakts\r\nnew_contact.insert(ignore_permissions=True)\r\n\r\n# Step 5: Add phone numbers\r\nif doc.telefon:\r\n    new_contact.append(\"phone_nos\", {\r\n        \"phone\": doc.telefon,\r\n        \"is_primary_phone\": 1\r\n    })\r\n\r\nif doc.telefon_zentrale:\r\n    new_contact.append(\"phone_nos\", {\r\n        \"phone\": doc.telefon_zentrale\r\n    })\r\n\r\n# Speichern des Kontakts nach dem Hinzufügen der Telefonnummern\r\nnew_contact.save(ignore_permissions=True)\r\n\r\n# Step 6: Add email addresses\r\nif doc.email_ansprechpartner:\r\n    new_contact.append(\"email_ids\", {\r\n        \"email_id\": doc.email_ansprechpartner,\r\n        \"is_primary\": 1\r\n    })\r\n\r\nif doc.email:\r\n    new_contact.append(\"email_ids\", {\r\n        \"email_id\": doc.email\r\n    })\r\n\r\n# Speichern des Kontakts nach dem Hinzufügen der E-Mail-Adressen\r\nnew_contact.save(ignore_permissions=True)\r\n\r\n# Step 7: Create new Address entry\r\nnew_address = frappe.get_doc({\r\n    \"doctype\": \"Address\",\r\n    \"address_title\": doc.kompletter_name,\r\n    \"address_type\": \"Other\",\r\n    \"address_line1\": doc.adresse_zeile_1,\r\n    \"address_line2\": doc.adresse_zeile_2,\r\n    \"city\": doc.ort_wohnort,\r\n    \"county\": doc.land,\r\n    \"pincode\": doc.plz,\r\n    \"email_id\": doc.email,\r\n    \"phone\": doc.telefon,\r\n    \"is_primary_address\": doc.ist_hauptkontakt,\r\n    \"is_shipping_address\": doc.ist_versandanschrift\r\n})\r\n\r\n# Link Address to Lead\r\nnew_address.append(\"links\", {\r\n    \"link_doctype\": \"Lead\",\r\n    \"link_name\": new_lead.name\r\n})\r\n\r\n# Speichern der Adresse\r\nnew_address.insert(ignore_permissions=True)\r\n\r\n# Step 8: Update Lead with Contact ID\r\nnew_lead.custom_aktueller_primärkontakt = new_contact.name\r\nnew_lead.save(ignore_permissions=True)\r\n\r\n# Step 9: Add the link from Contact to Lead\r\nnew_contact.append(\"links\", {\r\n    \"link_doctype\": \"Lead\",\r\n    \"link_name\": new_lead.name,\r\n    \"link_title\": new_lead.lead_name\r\n})\r\n\r\n# Speichern des Kontakts nach Hinzufügen des Links\r\nnew_contact.save(ignore_permissions=True)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-02-06 15:48:40.458459",
  "module": "Ersteingabe Lead",
  "name": "Testscript",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lead",
  "script": "pass",
  "script_type": "DocType Event"
 }
]